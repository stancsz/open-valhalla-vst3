name: CMake Build and Release

on:
  workflow_dispatch:

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
      commit_sha: ${{ steps.commit.outputs.sha }}
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Bump Version
      id: bump
      run: |
        VERSION=$(python .github/scripts/bump_version.py)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "New version: $VERSION"

    - name: Commit Version Bump
      id: commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add CMakeLists.txt
        git commit -m "Bump version to ${{ steps.bump.outputs.version }} [skip ci]"
        git push
        echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  build-windows:
    name: Build Windows
    needs: bump-version
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.bump-version.outputs.commit_sha }}

    - name: Configure CMake
      run: cmake -B build -S .

    - name: Build
      run: cmake --build build --config Release

    - name: Package Windows
      run: |
        mkdir package_win
        if (Test-Path "build/VST3OpenValhalla_artefacts/Release/VST3") {
          Copy-Item -Path "build/VST3OpenValhalla_artefacts/Release/VST3" -Destination "package_win" -Recurse
        }
        if (Test-Path "build/VST3OpenValhalla_artefacts/Release/Standalone") {
          Copy-Item -Path "build/VST3OpenValhalla_artefacts/Release/Standalone" -Destination "package_win" -Recurse
        }
        Compress-Archive -Path "package_win/*" -DestinationPath "Open_Valhalla_VST3_Windows.zip"

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Open_Valhalla_VST3_Windows
        path: Open_Valhalla_VST3_Windows.zip

  build-linux:
    name: Build Linux
    needs: bump-version
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.bump-version.outputs.commit_sha }}

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2-dev libx11-dev libxinerama-dev libxext-dev libfreetype6-dev libwebkit2gtk-4.1-dev libglu1-mesa-dev

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Package Linux
      run: |
        mkdir package_linux
        cp -r build/VST3OpenValhalla_artefacts/VST3 package_linux/
        cp -r build/VST3OpenValhalla_artefacts/Standalone package_linux/
        cd package_linux
        zip -r ../Open_Valhalla_VST3_Linux.zip .
        cd ..

    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Open_Valhalla_VST3_Linux
        path: Open_Valhalla_VST3_Linux.zip

  release:
    name: Create Release
    needs: [bump-version, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.bump-version.outputs.commit_sha }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: Open_Valhalla_VST3_Windows
        path: .

    - name: Download Linux Artifact
      uses: actions/download-artifact@v4
      with:
        name: Open_Valhalla_VST3_Linux
        path: .

    - name: Commit Artifacts to Repo
      id: commit_artifacts
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Ensure we are on a branch to pull/push
        git checkout -B main
        git pull origin main --rebase

        mkdir -p release
        mv Open_Valhalla_VST3_Windows.zip release/
        mv Open_Valhalla_VST3_Linux.zip release/

        git add release/
        git commit -m "Add release artifacts for version ${{ needs.bump-version.outputs.new_version }} [skip ci]"
        git push origin main

        echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.bump-version.outputs.new_version }}
        name: Release v${{ needs.bump-version.outputs.new_version }}
        target_commitish: ${{ steps.commit_artifacts.outputs.sha }}
        files: |
          release/Open_Valhalla_VST3_Windows.zip
          release/Open_Valhalla_VST3_Linux.zip
